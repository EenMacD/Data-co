<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Companies House Bulk Data Ingestion</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.6;
            overflow-y: scroll;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: #2c3e50;
            color: white;
            padding: 20px 0;
            margin-bottom: 30px;
        }

        h1 {
            font-size: 28px;
            font-weight: 600;
        }

        h2 {
            font-size: 20px;
            margin-bottom: 15px;
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 8px;
        }

        h3 {
            font-size: 16px;
            margin-bottom: 10px;
            color: #34495e;
        }

        .card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
            font-size: 14px;
        }

        input[type="date"],
        input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input[type="date"]:focus,
        input[type="text"]:focus {
            outline: none;
            border-color: #3498db;
        }

        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.3s;
        }

        button:hover {
            background: #2980b9;
        }

        button:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn-success {
            background: #27ae60;
        }

        .btn-success:hover {
            background: #229954;
        }

        .btn-danger {
            background: #e74c3c;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-warning {
            background: #f39c12;
        }

        .btn-warning:hover {
            background: #d68910;
        }

        .file-panels {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-top: 20px;
        }

        .file-panel {
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 15px;
            background: #f8f9fa;
        }

        .file-panel h3 {
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #3498db;
        }

        .file-list {
            max-height: 400px;
            overflow-y: scroll;
            background: white;
            border-radius: 4px;
            padding: 10px;
        }

        .file-list::-webkit-scrollbar {
            width: 12px;
        }

        .file-list::-webkit-scrollbar-track {
            background: #e0e0e0;
            border-radius: 4px;
        }

        .file-list::-webkit-scrollbar-thumb {
            background: #666;
            border-radius: 4px;
        }

        .file-list::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .file-item {
            display: flex;
            align-items: center;
            padding: 8px;
            margin-bottom: 5px;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .file-item:hover {
            background: #e8f5e9;
        }

        .file-item input[type="checkbox"] {
            margin-right: 10px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .file-item label {
            margin: 0;
            cursor: pointer;
            font-size: 13px;
            font-weight: normal;
            flex: 1;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .stat-card {
            background: #ecf0f1;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #2c3e50;
        }

        .stat-label {
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 5px;
        }

        .selected-files-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .selected-files-table th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #dee2e6;
        }

        .selected-files-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #dee2e6;
        }

        .selected-files-table tr:hover {
            background: #f8f9fa;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 13px;
        }

        .progress-container {
            margin-top: 15px;
            display: none;
        }

        .progress-bar-wrapper {
            width: 100%;
            height: 30px;
            background: #ecf0f1;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            width: 0%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }

        .progress-info {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 13px;
            color: #7f8c8d;
        }

        #logs {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 4px;
            height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.4;
        }

        #logs::-webkit-scrollbar {
            width: 8px;
        }

        #logs::-webkit-scrollbar-track {
            background: #2d2d2d;
        }

        #logs::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 4px;
        }

        .log-line {
            margin-bottom: 2px;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-running {
            background: #3498db;
            color: white;
        }

        .status-completed {
            background: #27ae60;
            color: white;
        }

        .status-failed {
            background: #e74c3c;
            color: white;
        }

        .status-idle {
            background: #95a5a6;
            color: white;
        }

        .status-stopped {
            background: #f39c12;
            color: white;
        }

        .help-text {
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 5px;
        }

        .date-range {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 15px;
            align-items: end;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }

        .file-type-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 600;
            margin-right: 8px;
        }

        .badge-company {
            background: #d4edda;
            color: #155724;
        }

        .badge-psc {
            background: #cce5ff;
            color: #004085;
        }

        .badge-accounts {
            background: #fff3cd;
            color: #856404;
        }

        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .checkbox-select-all {
            margin-bottom: 10px;
            padding: 8px;
            background: #e8f5e9;
            border-radius: 4px;
            display: flex;
            align-items: center;
        }

        .checkbox-select-all input {
            margin-right: 8px;
        }

        .checkbox-select-all label {
            font-weight: 600;
            color: #27ae60;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.2s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 0;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            padding: 20px;
            background: #2c3e50;
            color: white;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            color: white;
            font-size: 18px;
        }

        .modal-close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            background: none;
            border: none;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
            border-radius: 4px;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 15px 20px;
            background: #f8f9fa;
            border-radius: 0 0 8px 8px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .btn-secondary {
            background: #95a5a6;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>Companies House Bulk Data Ingestion</h1>
        </div>
    </header>

    <div class="container">
        <!-- 1. Date Range Selection -->
        <div class="card">
            <h2>1. Select Date Range</h2>
            <div class="date-range">
                <div class="form-group" style="margin-bottom: 0;">
                    <label for="startDate">Start Date</label>
                    <input type="date" id="startDate">
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label for="endDate">End Date</label>
                    <input type="date" id="endDate">
                </div>
                <button id="discoverBtn" class="btn-success">Discover Files</button>
            </div>
            <div class="help-text">Select date range to discover available monthly snapshot files from Companies House</div>
        </div>

        <!-- 2. File Selection Panels -->
        <div class="card" id="fileSelectionCard" style="display: none;">
            <h2>2. Select Files to Ingest</h2>
            <div class="file-panels">
                <!-- Company Data Panel -->
                <div class="file-panel">
                    <h3>Company Data</h3>
                    <div class="checkbox-select-all">
                        <input type="checkbox" id="selectAllCompany">
                        <label for="selectAllCompany">Select All</label>
                    </div>
                    <div class="file-list" id="companyFileList">
                        <div class="empty-state">Click "Discover Files" to load available files</div>
                    </div>
                </div>

                <!-- PSC Data Panel -->
                <div class="file-panel">
                    <h3>PSC Data</h3>
                    <div class="checkbox-select-all">
                        <input type="checkbox" id="selectAllPSC">
                        <label for="selectAllPSC">Select All</label>
                    </div>
                    <div class="file-list" id="pscFileList">
                        <div class="empty-state">Click "Discover Files" to load available files</div>
                    </div>
                </div>

                <!-- Accounts Data Panel -->
                <div class="file-panel">
                    <h3>Accounts Data</h3>
                    <div class="checkbox-select-all">
                        <input type="checkbox" id="selectAllAccounts">
                        <label for="selectAllAccounts">Select All</label>
                    </div>
                    <div class="file-list" id="accountsFileList">
                        <div class="empty-state">Click "Discover Files" to load available files</div>
                    </div>
                </div>
            </div>
            <div class="button-group">
                <button id="addToListBtn" class="btn-success">Add Selected to Ingestion List</button>
            </div>
        </div>

        <!-- 3. Selected Files List -->
        <div class="card" id="selectedFilesCard" style="display: none;">
            <h2>3. Ingestion List</h2>
            <div id="selectedFilesContainer">
                <table class="selected-files-table">
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Filename</th>
                            <th>Date</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="selectedFilesBody">
                    </tbody>
                </table>
            </div>
            <div class="button-group">
                <button id="clearListBtn" class="btn-danger">Clear List</button>
                <button id="startIngestionBtn" class="btn-success" style="margin-left: auto;">Start Ingestion</button>
            </div>
        </div>

        <!-- 4. Status & Progress -->
        <div class="card">
            <h2>Status & Progress</h2>
            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                <span id="statusBadge" class="status-badge status-idle">Idle</span>
                <span id="statusText">Ready to start</span>
            </div>

            <div class="button-group">
                <button id="stopIngestionBtn" class="btn-danger" style="display: none;">Stop After Current File</button>
                <button id="resumeIngestionBtn" class="btn-warning" style="display: none;">Resume Ingestion</button>
                <button id="refreshStatusBtn" style="margin-left: auto;">Refresh Status</button>
            </div>

            <!-- Progress Bar -->
            <div class="progress-container" id="progressContainer">
                <div class="progress-bar-wrapper">
                    <div class="progress-bar" id="progressBar">0%</div>
                </div>
                <div class="progress-info">
                    <span id="progressText">Waiting to start...</span>
                    <span id="currentFile"></span>
                </div>
            </div>

            <!-- Database Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="totalCompanies">0</div>
                    <div class="stat-label">Total Companies</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalOfficers">0</div>
                    <div class="stat-label">Total Officers</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalFinancials">0</div>
                    <div class="stat-label">Total Financials</div>
                </div>
            </div>
        </div>

        <!-- 5. Live Logs -->
        <div class="card">
            <h2>Live Logs</h2>
            <div id="logs"></div>
        </div>
    </div>

    <!-- Confirmation Modal for Start Ingestion -->
    <div id="startIngestionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Confirm Start Ingestion</h3>
                <button class="modal-close" onclick="closeStartModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to start the ingestion process?</p>
                <p><strong id="modalFileCount"></strong></p>
                <p style="color: #7f8c8d; font-size: 14px; margin-top: 10px;">This will begin processing the selected files and may take some time to complete.</p>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeStartModal()">Cancel</button>
                <button class="btn-success" onclick="confirmStartIngestion()">Start Ingestion</button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal for Stop Ingestion -->
    <div id="stopIngestionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Confirm Stop Ingestion</h3>
                <button class="modal-close" onclick="closeStopModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to stop the ingestion process?</p>
                <p style="color: #7f8c8d; font-size: 14px; margin-top: 10px;">The current file will finish processing before stopping. You can resume later from where it stopped.</p>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeStopModal()">Cancel</button>
                <button class="btn-danger" onclick="confirmStopIngestion()">Stop After Current File</button>
            </div>
        </div>
    </div>

    <script>
        let eventSource = null;
        let availableFiles = { company: [], psc: [], accounts: [] };
        let selectedFiles = [];

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            refreshStatus();
            connectEventSource();

            // Set default date range (last 3 months)
            const endDate = new Date();
            const startDate = new Date();
            startDate.setMonth(startDate.getMonth() - 3);

            document.getElementById('endDate').valueAsDate = endDate;
            document.getElementById('startDate').valueAsDate = startDate;
        });

        // Discover Files
        document.getElementById('discoverBtn').addEventListener('click', async () => {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            if (!startDate || !endDate) {
                addLog('[UI] Please select both start and end dates', 'error');
                return;
            }

            addLog('[UI] Discovering available files...', 'info');
            document.getElementById('discoverBtn').disabled = true;
            document.getElementById('discoverBtn').textContent = 'Discovering...';

            // Show loading spinners
            document.getElementById('companyFileList').innerHTML = '<div class="loading-spinner"></div>';
            document.getElementById('pscFileList').innerHTML = '<div class="loading-spinner"></div>';
            document.getElementById('accountsFileList').innerHTML = '<div class="loading-spinner"></div>';
            document.getElementById('fileSelectionCard').style.display = 'block';

            try {
                const response = await fetch('/api/discover-files', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ start_date: startDate, end_date: endDate })
                });

                const result = await response.json();

                if (result.success) {
                    availableFiles = result.files;
                    renderFileSelections();
                    addLog(`[UI] Found ${result.files.company.length} company, ${result.files.psc.length} PSC, ${result.files.accounts.length} accounts files`, 'success');
                } else {
                    addLog('[UI] Error discovering files: ' + result.error, 'error');
                    document.getElementById('fileSelectionCard').style.display = 'none';
                }
            } catch (error) {
                addLog('[UI] Error: ' + error.message, 'error');
                document.getElementById('fileSelectionCard').style.display = 'none';
            } finally {
                document.getElementById('discoverBtn').disabled = false;
                document.getElementById('discoverBtn').textContent = 'Discover Files';
            }
        });

        // Render file selections
        function renderFileSelections() {
            renderFileList('company', availableFiles.company, 'companyFileList', 'badge-company');
            renderFileList('psc', availableFiles.psc, 'pscFileList', 'badge-psc');
            renderFileList('accounts', availableFiles.accounts, 'accountsFileList', 'badge-accounts');
        }

        function renderFileList(type, files, containerId, badgeClass) {
            const container = document.getElementById(containerId);

            if (files.length === 0) {
                container.innerHTML = '<div class="empty-state">No files found for this date range</div>';
                return;
            }

            let html = '';
            files.forEach((file, idx) => {
                const fileId = `${type}_${idx}`;
                html += `
                    <div class="file-item">
                        <input type="checkbox" id="${fileId}" data-type="${type}" data-url="${file.url}" data-filename="${file.filename}" data-date="${file.date}">
                        <label for="${fileId}">${file.filename}</label>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        // Select all checkboxes
        document.getElementById('selectAllCompany').addEventListener('change', (e) => {
            document.querySelectorAll('#companyFileList input[type="checkbox"]').forEach(cb => cb.checked = e.target.checked);
        });

        document.getElementById('selectAllPSC').addEventListener('change', (e) => {
            document.querySelectorAll('#pscFileList input[type="checkbox"]').forEach(cb => cb.checked = e.target.checked);
        });

        document.getElementById('selectAllAccounts').addEventListener('change', (e) => {
            document.querySelectorAll('#accountsFileList input[type="checkbox"]').forEach(cb => cb.checked = e.target.checked);
        });

        // Add to ingestion list
        document.getElementById('addToListBtn').addEventListener('click', () => {
            const checkboxes = document.querySelectorAll('.file-list input[type="checkbox"]:checked');
            let addedCount = 0;

            checkboxes.forEach(checkbox => {
                const file = {
                    product: checkbox.dataset.type,  // Backend expects 'product' key
                    url: checkbox.dataset.url,
                    filename: checkbox.dataset.filename,
                    date: checkbox.dataset.date
                };

                // Check if already in list
                const exists = selectedFiles.some(f => f.url === file.url);
                if (!exists) {
                    selectedFiles.push(file);
                    addedCount++;
                }
            });

            if (addedCount > 0) {
                renderSelectedFiles();
                addLog(`[UI] Added ${addedCount} file(s) to ingestion list`, 'success');
                document.getElementById('selectedFilesCard').style.display = 'block';
            } else {
                addLog('[UI] No new files to add', 'info');
            }
        });

        // Render selected files table
        function renderSelectedFiles() {
            const tbody = document.getElementById('selectedFilesBody');

            if (selectedFiles.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px; color: #7f8c8d;">No files selected</td></tr>';
                return;
            }

            let html = '';
            selectedFiles.forEach((file, idx) => {
                const badgeClass = file.product === 'company' ? 'badge-company' :
                                   file.product === 'psc' ? 'badge-psc' : 'badge-accounts';
                html += `
                    <tr>
                        <td><span class="file-type-badge ${badgeClass}">${file.product.toUpperCase()}</span></td>
                        <td>${file.filename}</td>
                        <td>${file.date}</td>
                        <td><button class="btn-small btn-danger" onclick="removeFile(${idx})">Remove</button></td>
                    </tr>
                `;
            });
            tbody.innerHTML = html;
        }

        // Remove file from list
        function removeFile(index) {
            selectedFiles.splice(index, 1);
            renderSelectedFiles();
            if (selectedFiles.length === 0) {
                document.getElementById('selectedFilesCard').style.display = 'none';
            }
            addLog('[UI] File removed from ingestion list', 'info');
        }

        // Clear list
        document.getElementById('clearListBtn').addEventListener('click', () => {
            if (confirm('Clear all files from the ingestion list?')) {
                selectedFiles = [];
                renderSelectedFiles();
                document.getElementById('selectedFilesCard').style.display = 'none';
                addLog('[UI] Ingestion list cleared', 'info');
            }
        });

        // Start Ingestion - Show Modal
        document.getElementById('startIngestionBtn').addEventListener('click', () => {
            if (selectedFiles.length === 0) {
                addLog('[UI] No files in ingestion list', 'error');
                return;
            }

            // Show modal with file count
            document.getElementById('modalFileCount').textContent = `${selectedFiles.length} file(s) will be processed`;
            document.getElementById('startIngestionModal').style.display = 'block';
        });

        // Modal functions for Start Ingestion
        function closeStartModal() {
            document.getElementById('startIngestionModal').style.display = 'none';
        }

        async function confirmStartIngestion() {
            closeStartModal();

            try {
                const response = await fetch('/api/ingestion/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ files: selectedFiles })
                });

                const result = await response.json();

                if (result.success) {
                    addLog(`[UI] Started ingestion of ${selectedFiles.length} file(s)`, 'success');
                    document.getElementById('statusBadge').className = 'status-badge status-running';
                    document.getElementById('statusBadge').textContent = 'Running';
                    document.getElementById('startIngestionBtn').style.display = 'none';
                    document.getElementById('stopIngestionBtn').style.display = 'inline-block';
                    document.getElementById('progressContainer').style.display = 'block';
                } else {
                    addLog('[UI] Error starting ingestion: ' + result.error, 'error');
                }
            } catch (error) {
                addLog('[UI] Error: ' + error.message, 'error');
            }
        }

        // Stop Ingestion - Show Modal
        document.getElementById('stopIngestionBtn').addEventListener('click', () => {
            document.getElementById('stopIngestionModal').style.display = 'block';
        });

        // Modal functions for Stop Ingestion
        function closeStopModal() {
            document.getElementById('stopIngestionModal').style.display = 'none';
        }

        async function confirmStopIngestion() {
            closeStopModal();

            try {
                const response = await fetch('/api/ingestion/stop', { method: 'POST' });
                const result = await response.json();

                if (result.success) {
                    addLog('[UI] Stopping ingestion after current file...', 'info');
                    document.getElementById('statusBadge').className = 'status-badge status-stopped';
                    document.getElementById('statusBadge').textContent = 'Stopping';
                } else {
                    addLog('[UI] Error stopping ingestion: ' + result.error, 'error');
                }
            } catch (error) {
                addLog('[UI] Error: ' + error.message, 'error');
            }
        }

        // Resume Ingestion
        document.getElementById('resumeIngestionBtn').addEventListener('click', async () => {
            try {
                const response = await fetch('/api/ingestion/resume', { method: 'POST' });
                const result = await response.json();

                if (result.success) {
                    addLog('[UI] Resuming ingestion...', 'info');
                    document.getElementById('statusBadge').className = 'status-badge status-running';
                    document.getElementById('statusBadge').textContent = 'Running';
                    document.getElementById('resumeIngestionBtn').style.display = 'none';
                    document.getElementById('stopIngestionBtn').style.display = 'inline-block';
                    document.getElementById('progressContainer').style.display = 'block';
                } else {
                    addLog('[UI] Error resuming ingestion: ' + result.error, 'error');
                }
            } catch (error) {
                addLog('[UI] Error: ' + error.message, 'error');
            }
        });

        // Refresh Status
        document.getElementById('refreshStatusBtn').addEventListener('click', refreshStatus);

        async function refreshStatus() {
            try {
                const statusResponse = await fetch('/api/status');
                const status = await statusResponse.json();

                document.getElementById('totalCompanies').textContent = status.total_companies || 0;
                document.getElementById('totalOfficers').textContent = status.total_officers || 0;
                document.getElementById('totalFinancials').textContent = status.total_financials || 0;

                const ingestionResponse = await fetch('/api/ingestion/status');
                const ingestionData = await ingestionResponse.json();

                // Extract progress object from response
                const progress = ingestionData.progress;
                const isRunning = ingestionData.is_running;

                if (progress && progress.status === 'running') {
                    document.getElementById('statusBadge').className = 'status-badge status-running';
                    document.getElementById('statusBadge').textContent = 'Running';
                    document.getElementById('statusText').textContent = progress.current_file || 'Processing...';
                    document.getElementById('startIngestionBtn').style.display = 'none';
                    document.getElementById('stopIngestionBtn').style.display = 'inline-block';
                    document.getElementById('resumeIngestionBtn').style.display = 'none';
                    document.getElementById('progressContainer').style.display = 'block';
                    updateProgressBar(progress.files_completed, progress.files_total, progress.current_file);
                } else if (progress && progress.status === 'stopped') {
                    document.getElementById('statusBadge').className = 'status-badge status-stopped';
                    document.getElementById('statusBadge').textContent = 'Stopped';
                    document.getElementById('statusText').textContent = `Stopped at ${progress.files_completed}/${progress.files_total} files`;
                    document.getElementById('stopIngestionBtn').style.display = 'none';
                    document.getElementById('resumeIngestionBtn').style.display = 'inline-block';
                    document.getElementById('progressContainer').style.display = 'block';
                    updateProgressBar(progress.files_completed, progress.files_total, progress.current_file);
                } else if (progress && progress.status === 'completed') {
                    document.getElementById('statusBadge').className = 'status-badge status-completed';
                    document.getElementById('statusBadge').textContent = 'Completed';
                    document.getElementById('statusText').textContent = `Completed ${progress.files_completed} files`;
                    document.getElementById('startIngestionBtn').style.display = 'inline-block';
                    document.getElementById('stopIngestionBtn').style.display = 'none';
                    document.getElementById('resumeIngestionBtn').style.display = 'none';
                    document.getElementById('progressContainer').style.display = 'block';
                    updateProgressBar(progress.files_completed, progress.files_total, '');
                } else if (progress && progress.status === 'failed') {
                    document.getElementById('statusBadge').className = 'status-badge status-failed';
                    document.getElementById('statusBadge').textContent = 'Failed';
                    document.getElementById('statusText').textContent = progress.error || 'Error occurred';
                    document.getElementById('stopIngestionBtn').style.display = 'none';
                    document.getElementById('resumeIngestionBtn').style.display = 'inline-block';
                } else {
                    document.getElementById('statusBadge').className = 'status-badge status-idle';
                    document.getElementById('statusBadge').textContent = 'Idle';
                    document.getElementById('statusText').textContent = 'Ready to start';
                    document.getElementById('startIngestionBtn').style.display = 'inline-block';
                    document.getElementById('stopIngestionBtn').style.display = 'none';
                    document.getElementById('resumeIngestionBtn').style.display = 'none';
                    document.getElementById('progressContainer').style.display = 'none';
                }
            } catch (error) {
                console.error('Error refreshing status:', error);
            }
        }

        function updateProgressBar(completed, total, currentFile) {
            const percentage = total > 0 ? (completed / total) * 100 : 0;
            document.getElementById('progressBar').style.width = percentage + '%';
            document.getElementById('progressBar').textContent = Math.round(percentage) + '%';
            document.getElementById('progressText').textContent = `${completed} of ${total} files completed`;
            document.getElementById('currentFile').textContent = currentFile || '';
        }

        // Connect to SSE logs
        function connectEventSource() {
            eventSource = new EventSource('/api/logs');

            eventSource.onmessage = (event) => {
                if (event.data.trim()) {
                    try {
                        const data = JSON.parse(event.data);
                        if (data.message) {
                            addLog(data.message);
                        }
                        // Ignore heartbeat messages
                    } catch (e) {
                        // If not JSON, just log the raw data
                        addLog(event.data);
                    }
                }
            };

            eventSource.onerror = (error) => {
                console.error('EventSource error:', error);
                setTimeout(() => connectEventSource(), 5000);
            };
        }

        function addLog(message, type = 'info') {
            const logsDiv = document.getElementById('logs');
            const logLine = document.createElement('div');
            logLine.className = 'log-line';

            const timestamp = new Date().toLocaleTimeString();
            logLine.textContent = `[${timestamp}] ${message}`;

            if (type === 'error') {
                logLine.style.color = '#e74c3c';
            } else if (type === 'success') {
                logLine.style.color = '#27ae60';
            } else if (type === 'info') {
                logLine.style.color = '#3498db';
            }

            logsDiv.appendChild(logLine);
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            const startModal = document.getElementById('startIngestionModal');
            const stopModal = document.getElementById('stopIngestionModal');

            if (event.target === startModal) {
                closeStartModal();
            } else if (event.target === stopModal) {
                closeStopModal();
            }
        }

        // Auto-refresh status every 5 seconds
        setInterval(refreshStatus, 5000);
    </script>
</body>
</html>
