<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Scraping Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: #2c3e50;
            color: white;
            padding: 20px 0;
            margin-bottom: 30px;
        }

        h1 {
            font-size: 28px;
            font-weight: 600;
        }

        h2 {
            font-size: 20px;
            margin-bottom: 15px;
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 8px;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
            font-size: 14px;
        }

        input[type="text"],
        input[type="number"],
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        select:focus {
            outline: none;
            border-color: #3498db;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .checkbox-group label {
            margin: 0;
            cursor: pointer;
        }

        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.3s;
        }

        button:hover {
            background: #2980b9;
        }

        button:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn-success {
            background: #27ae60;
        }

        .btn-success:hover {
            background: #229954;
        }

        .btn-danger {
            background: #e74c3c;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        #logs {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 4px;
            height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.4;
        }

        #logs::-webkit-scrollbar {
            width: 8px;
        }

        #logs::-webkit-scrollbar-track {
            background: #2d2d2d;
        }

        #logs::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 4px;
        }

        .log-line {
            margin-bottom: 2px;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-running {
            background: #3498db;
            color: white;
        }

        .status-completed {
            background: #27ae60;
            color: white;
        }

        .status-failed {
            background: #e74c3c;
            color: white;
        }

        .status-idle {
            background: #95a5a6;
            color: white;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .stat-card {
            background: #ecf0f1;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #2c3e50;
        }

        .stat-label {
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 5px;
        }

        .help-text {
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 5px;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .section {
            margin-bottom: 25px;
        }

        .duplicate-item {
            background: #fff3e0;
            border-left: 4px solid #e67e22;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 4px;
        }

        .duplicate-header {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 10px;
            color: #d35400;
        }

        .duplicate-records {
            display: grid;
            gap: 10px;
            margin-top: 10px;
        }

        .duplicate-record {
            background: white;
            padding: 12px;
            border-radius: 4px;
            border: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .duplicate-record.selected {
            border-color: #27ae60;
            background: #e8f5e9;
        }

        .duplicate-info {
            flex: 1;
        }

        .duplicate-info span {
            display: inline-block;
            margin-right: 15px;
            font-size: 13px;
        }

        .duplicate-actions {
            display: flex;
            gap: 8px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 13px;
        }

        .data-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 11px;
            margin-right: 5px;
        }

        .badge-yes {
            background: #d4edda;
            color: #155724;
        }

        .badge-no {
            background: #f8d7da;
            color: #721c24;
        }

        .progress-container {
            margin-top: 15px;
            display: none;
        }

        .progress-bar-wrapper {
            width: 100%;
            height: 30px;
            background: #ecf0f1;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            width: 0%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }

        .progress-info {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 13px;
            color: #7f8c8d;
        }

        .progress-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .progress-stat {
            background: #f8f9fa;
            padding: 8px;
            border-radius: 4px;
            text-align: center;
            border: 1px solid #dee2e6;
        }

        .progress-stat-value {
            font-size: 18px;
            font-weight: 700;
            color: #2c3e50;
        }

        .progress-stat-label {
            font-size: 11px;
            color: #7f8c8d;
            margin-top: 2px;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>Data Scraping Dashboard</h1>
        </div>
    </header>

    <div class="container">
        <!-- Status Card -->
        <div class="card full-width" style="margin-bottom: 20px;">
            <h2>Current Status</h2>
            <div style="display: flex; align-items: center; gap: 15px; margin-top: 10px;">
                <span id="statusBadge" class="status-badge status-idle">Idle</span>
                <span id="statusText">Ready to start scraping</span>
            </div>

            <!-- Progress Bar -->
            <div class="progress-container" id="progressContainer">
                <div class="progress-bar-wrapper">
                    <div class="progress-bar" id="progressBar">0%</div>
                </div>
                <div class="progress-info">
                    <span id="progressText">Processing companies...</span>
                    <span id="progressETA">ETA: Calculating...</span>
                </div>
                <div class="progress-stats">
                    <div class="progress-stat">
                        <div class="progress-stat-value" id="progressCompleted">0</div>
                        <div class="progress-stat-label">Completed</div>
                    </div>
                    <div class="progress-stat">
                        <div class="progress-stat-value" id="progressTotal">0</div>
                        <div class="progress-stat-label">Total</div>
                    </div>
                    <div class="progress-stat">
                        <div class="progress-stat-value" id="progressRate">0.0</div>
                        <div class="progress-stat-label">Companies/sec</div>
                    </div>
                    <div class="progress-stat">
                        <div class="progress-stat-value" id="progressElapsed">0s</div>
                        <div class="progress-stat-label">Elapsed</div>
                    </div>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="totalCompanies">0</div>
                    <div class="stat-label">Total Companies</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalOfficers">0</div>
                    <div class="stat-label">Total Officers</div>
                </div>
            </div>
        </div>

        <!-- Configuration -->
        <div class="grid">
            <!-- Search Criteria -->
            <div class="card">
                <h2>Search Criteria</h2>

                <div class="form-group">
                    <label for="searchName">Search Name</label>
                    <input type="text" id="searchName" placeholder="e.g., glasgow_all_companies" value="{{ config.search_criteria.name }}">
                    <div class="help-text">Unique identifier for this search</div>
                </div>

                <div class="form-group">
                    <label for="locality">Locality (City)</label>
                    <input type="text" id="locality" placeholder="e.g., Glasgow" value="{{ config.search_criteria.selection.locality or '' }}">
                    <div class="help-text">Filter by city/town (leave empty for all)</div>
                </div>

                <div class="form-group">
                    <label for="companyStatus">Company Status</label>
                    <select id="companyStatus">
                        <option value="">All Statuses</option>
                        <option value="active" {% if config.search_criteria.selection.company_status == 'active' %}selected{% endif %}>Active</option>
                        <option value="dissolved">Dissolved</option>
                        <option value="liquidation">Liquidation</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="sicCodes">SIC Codes (comma-separated)</label>
                    <input type="text" id="sicCodes" placeholder="e.g., 41, 42, 43" value="{{ config.search_criteria.selection.industry_codes.include | join(', ') if config.search_criteria.selection.industry_codes else '' }}">
                    <div class="help-text">Industry codes to filter (leave empty for all)</div>
                </div>

                <div class="form-group">
                    <label for="limit">Limit (companies)</label>
                    <input type="number" id="limit" placeholder="Leave empty for all" value="{{ config.search_criteria.selection.limit or '' }}">
                    <div class="help-text">Maximum companies to process (empty = all)</div>
                </div>
            </div>

            <!-- Technical Settings -->
            <div class="card">
                <h2>Technical Settings</h2>

                <div class="section">
                    <h3 style="font-size: 16px; margin-bottom: 10px; color: #34495e;">Bulk Download</h3>
                    <div class="form-group">
                        <label for="dateOverride">Data Snapshot Date</label>
                        <input type="text" id="dateOverride" placeholder="YYYY-MM-DD" value="{{ config.technical_config.bulk_download.date_override }}">
                        <div class="help-text">Which snapshot to use (e.g., 2025-10-01)</div>
                    </div>
                </div>

                <div class="section">
                    <h3 style="font-size: 16px; margin-bottom: 10px; color: #34495e;">API Enrichment</h3>
                    <div class="checkbox-group" style="margin-bottom: 10px;">
                        <input type="checkbox" id="apiEnabled" {% if config.technical_config.api_enrichment.enabled %}checked{% endif %}>
                        <label for="apiEnabled">Enable API Enrichment</label>
                    </div>

                    <div class="checkbox-group" style="margin-bottom: 10px; background: #e8f5e9; padding: 10px; border-radius: 4px;">
                        <input type="checkbox" id="incrementalMode" {% if config.technical_config.api_enrichment.get('incremental_mode', False) %}checked{% endif %}>
                        <label for="incrementalMode" style="font-weight: 600; color: #27ae60;">Incremental Update Mode</label>
                    </div>
                    <div class="help-text" style="margin-top: -8px; margin-bottom: 10px; background: #e8f5e9; padding: 0 10px 10px 38px; margin-left: 0; border-radius: 0 0 4px 4px;">
                        Only fetch missing data for existing companies. Skips duplicates and saves time.
                    </div>

                    <div class="form-group">
                        <label for="rateLimit">Rate Limit (requests/min)</label>
                        <input type="number" id="rateLimit" value="{{ config.technical_config.api_enrichment.request_rate_per_minute }}">
                    </div>
                </div>

                <div class="section">
                    <h3 style="font-size: 16px; margin-bottom: 10px; color: #34495e;">Financials</h3>
                    <div class="checkbox-group" style="margin-bottom: 10px;">
                        <input type="checkbox" id="financialsEnabled" {% if config.technical_config.financials_scan.enabled %}checked{% endif %}>
                        <label for="financialsEnabled">Enable Financial Data Extraction</label>
                    </div>

                    <div class="form-group">
                        <label for="windowYears">Historical Years</label>
                        <input type="number" id="windowYears" value="{{ config.technical_config.financials_scan.window_years }}">
                        <div class="help-text">Years of financial history to collect</div>
                    </div>

                    <div class="checkbox-group">
                        <input type="checkbox" id="parseIxbrl" {% if config.technical_config.financials_scan.parse_ixbrl %}checked{% endif %}>
                        <label for="parseIxbrl">Parse iXBRL</label>
                    </div>

                    <div class="checkbox-group">
                        <input type="checkbox" id="parseXbrl" {% if config.technical_config.financials_scan.parse_xbrl %}checked{% endif %}>
                        <label for="parseXbrl">Parse XBRL</label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="card full-width">
            <div class="button-group">
                <button id="previewBtn" style="background: #f39c12;">Preview Results</button>
                <button id="saveBtn" class="btn-success">Save Configuration</button>
                <button id="startBtn">Start Scraping</button>
                <button id="stopBtn" class="btn-danger" style="display: none;">Stop Scraping</button>
                <button id="refreshBtn" style="margin-left: auto;">Refresh Status</button>
            </div>
        </div>

        <!-- Preview Modal -->
        <div id="previewModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; overflow-y: auto;">
            <div style="background: white; margin: 50px auto; max-width: 900px; border-radius: 8px; padding: 30px; position: relative;">
                <button id="closePreview" style="position: absolute; top: 15px; right: 15px; background: #e74c3c; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Close</button>

                <h2 style="margin-bottom: 20px;">Preview Results</h2>

                <div id="previewContent">
                    <div style="text-align: center; padding: 40px;">
                        <div style="font-size: 48px;">‚è≥</div>
                        <p>Loading preview...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Logs -->
        <div class="card full-width">
            <h2>Logs</h2>
            <div id="logs"></div>
        </div>

        <!-- Duplicates Section -->
        <div class="card full-width" id="duplicatesSection" style="display: none;">
            <h2>Duplicate Companies Found</h2>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <span id="duplicateCount" style="color: #e67e22; font-weight: 600;">0 duplicates found</span>
                <div>
                    <button id="refreshDuplicatesBtn" style="background: #95a5a6;">Refresh Duplicates</button>
                    <button id="deleteUnselectedBtn" class="btn-danger" style="display: none;">Delete All Unselected</button>
                </div>
            </div>
            <div class="help-text" style="margin-bottom: 15px; color: #e67e22; background: #fff3e0; padding: 12px; border-radius: 4px; border-left: 4px solid #e67e22;">
                <strong>How it works:</strong> The best record (most recent with data) from each duplicate group is auto-selected to keep. Review and adjust selections, then click "Delete All Unselected" to remove duplicates.
            </div>
            <div style="margin-bottom: 15px;">
                <button id="autoSelectBestBtn" style="background: #9b59b6; color: white; padding: 8px 16px;">Auto-Select Best Records</button>
                <button id="clearSelectionsBtn" style="background: #7f8c8d; color: white; padding: 8px 16px; margin-left: 8px;">Clear All Selections</button>
            </div>
            <div id="duplicatesList"></div>
        </div>
    </div>

    <script>
        let eventSource = null;

        // Load status on page load
        document.addEventListener('DOMContentLoaded', () => {
            refreshStatus();
            connectEventSource();
        });

        // Preview results
        document.getElementById('previewBtn').addEventListener('click', async () => {
            const config = {
                locality: document.getElementById('locality').value,
                company_status: document.getElementById('companyStatus').value,
                sic_codes: document.getElementById('sicCodes').value,
                limit: document.getElementById('limit').value,
                fetch_sample_data: true
            };

            // Show modal
            document.getElementById('previewModal').style.display = 'block';
            document.getElementById('previewContent').innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <div style="font-size: 48px;">‚è≥</div>
                    <p>Loading preview...</p>
                </div>
            `;

            try {
                const response = await fetch('/api/preview', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });

                const result = await response.json();

                if (result.success) {
                    renderPreview(result);
                } else {
                    document.getElementById('previewContent').innerHTML = `
                        <div style="color: #e74c3c; padding: 20px;">
                            <h3>Error</h3>
                            <p>${result.error}</p>
                            ${result.traceback ? `<pre style="background: #f5f5f5; padding: 10px; overflow-x: auto;">${result.traceback}</pre>` : ''}
                        </div>
                    `;
                }
            } catch (error) {
                document.getElementById('previewContent').innerHTML = `
                    <div style="color: #e74c3c; padding: 20px;">
                        <h3>Error</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        });

        document.getElementById('closePreview').addEventListener('click', () => {
            document.getElementById('previewModal').style.display = 'none';
        });

        function renderPreview(data) {
            let html = '';

            // Summary
            html += `<div style="background: #e8f5e9; padding: 15px; border-radius: 4px; margin-bottom: 20px;">`;
            html += `<h3 style="margin: 0 0 10px 0;">üìä Summary</h3>`;
            html += `<p style="font-size: 18px; font-weight: 600; margin: 0;">Total Matches: ${data.total_matches}</p>`;
            if (data.message) html += `<p style="margin: 5px 0 0 0; color: #666;">${data.message}</p>`;
            html += `</div>`;

            // Statistics
            if (data.statistics) {
                html += `<div style="margin-bottom: 20px;">`;
                html += `<h3>Statistics</h3>`;

                if (data.statistics.by_status) {
                    html += `<div style="margin-bottom: 15px;">`;
                    html += `<strong>By Status:</strong><ul style="margin: 5px 0;">`;
                    for (const [status, count] of Object.entries(data.statistics.by_status)) {
                        html += `<li>${status}: ${count}</li>`;
                    }
                    html += `</ul></div>`;
                }

                if (data.statistics.top_localities) {
                    html += `<div>`;
                    html += `<strong>Top Localities:</strong><ul style="margin: 5px 0;">`;
                    for (const [locality, count] of Object.entries(data.statistics.top_localities)) {
                        html += `<li>${locality}: ${count}</li>`;
                    }
                    html += `</ul></div>`;
                }
                html += `</div>`;
            }

            // Sample companies
            if (data.sample_companies && data.sample_companies.length > 0) {
                html += `<div style="margin-bottom: 20px;">`;
                html += `<h3>Sample Companies (First 10)</h3>`;
                html += `<div style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px;">`;
                html += `<table style="width: 100%; border-collapse: collapse;">`;
                html += `<tr style="background: #f8f9fa;"><th style="padding: 8px; text-align: left;">Number</th><th style="padding: 8px; text-align: left;">Name</th><th style="padding: 8px; text-align: left;">Status</th><th style="padding: 8px; text-align: left;">Location</th></tr>`;

                data.sample_companies.forEach(company => {
                    html += `<tr style="border-top: 1px solid #ddd;">`;
                    html += `<td style="padding: 8px;">${company.company_number}</td>`;
                    html += `<td style="padding: 8px;">${company.company_name}</td>`;
                    html += `<td style="padding: 8px;">${company.status}</td>`;
                    html += `<td style="padding: 8px;">${company.locality}</td>`;
                    html += `</tr>`;
                });

                html += `</table></div></div>`;
            }

            // Sample API data
            if (data.sample_api_data) {
                html += `<div style="margin-bottom: 20px; background: #fff3e0; padding: 15px; border-radius: 4px;">`;
                html += `<h3>Sample API Data</h3>`;
                if (data.sample_api_data.note) {
                    html += `<p style="color: #666; font-style: italic;">${data.sample_api_data.note}</p>`;
                }
                if (data.sample_api_data.company) {
                    html += `<p><strong>Company:</strong> ${data.sample_api_data.company.company_number} - ${data.sample_api_data.company.company_name}</p>`;
                }
                if (data.sample_api_data.api_data) {
                    for (const [endpoint, apiData] of Object.entries(data.sample_api_data.api_data)) {
                        html += `<div style="margin-top: 15px;">`;
                        html += `<strong>${endpoint}:</strong>`;
                        html += `<pre style="background: #f5f5f5; padding: 10px; border-radius: 4px; overflow-x: auto; max-height: 300px;">${JSON.stringify(apiData, null, 2)}</pre>`;
                        html += `</div>`;
                    }
                }
                html += `</div>`;
            }

            document.getElementById('previewContent').innerHTML = html;
        }

        // Save configuration
        document.getElementById('saveBtn').addEventListener('click', async () => {
            const config = {
                search_name: document.getElementById('searchName').value,
                locality: document.getElementById('locality').value,
                company_status: document.getElementById('companyStatus').value,
                sic_codes: document.getElementById('sicCodes').value,
                limit: document.getElementById('limit').value,
                date_override: document.getElementById('dateOverride').value,
                api_enabled: document.getElementById('apiEnabled').checked,
                incremental_mode: document.getElementById('incrementalMode').checked,
                rate_limit: document.getElementById('rateLimit').value,
                endpoints: ['officers', 'persons-with-significant-control'],
                financials_enabled: document.getElementById('financialsEnabled').checked,
                window_years: document.getElementById('windowYears').value,
                window_days: 365,
                download_documents: true,
                merge_enriched: true,
                parse_ixbrl: document.getElementById('parseIxbrl').checked,
                parse_xbrl: document.getElementById('parseXbrl').checked,
                cleanup_documents: true,
                cleanup_financials: true,
                cleanup_raw: true
            };

            try {
                const response = await fetch('/api/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });

                const result = await response.json();

                if (result.success) {
                    addLog('[UI] Configuration saved successfully!', 'success');
                } else {
                    addLog('[UI] Error saving configuration: ' + result.error, 'error');
                }
            } catch (error) {
                addLog('[UI] Error: ' + error.message, 'error');
            }
        });

        // Start scraping
        document.getElementById('startBtn').addEventListener('click', async () => {
            if (!confirm('Start scraping with current configuration?')) return;

            try {
                const response = await fetch('/api/start', { method: 'POST' });
                const result = await response.json();

                if (result.success) {
                    addLog('[UI] Starting scraping workflow...', 'info');
                    document.getElementById('statusBadge').className = 'status-badge status-running';
                    document.getElementById('statusBadge').textContent = 'Running';
                    document.getElementById('statusText').textContent = 'Scraping in progress...';

                    // Toggle buttons
                    document.getElementById('startBtn').style.display = 'none';
                    document.getElementById('stopBtn').style.display = 'inline-block';

                    // Initialize progress tracking
                    scrapingStartTime = Date.now();
                    document.getElementById('progressContainer').style.display = 'block';
                    resetProgressBar();

                    // Start elapsed time counter
                    if (elapsedTimer) clearInterval(elapsedTimer);
                    elapsedTimer = setInterval(() => {
                        if (scrapingStartTime) {
                            updateElapsedTime(scrapingStartTime);
                        }
                    }, 1000);

                } else {
                    addLog('[UI] Error: ' + result.error, 'error');
                }
            } catch (error) {
                addLog('[UI] Error: ' + error.message, 'error');
            }
        });

        // Stop scraping
        document.getElementById('stopBtn').addEventListener('click', async () => {
            if (!confirm('Are you sure you want to stop the scraping process? Progress will be saved to the database.')) return;

            try {
                const response = await fetch('/api/stop', { method: 'POST' });
                const result = await response.json();

                if (result.success) {
                    addLog('[UI] Stopping scraping process...', 'info');
                    document.getElementById('statusBadge').className = 'status-badge status-idle';
                    document.getElementById('statusBadge').textContent = 'Stopped';
                    document.getElementById('statusText').textContent = 'Scraping stopped by user';

                    // Toggle buttons
                    document.getElementById('startBtn').style.display = 'inline-block';
                    document.getElementById('stopBtn').style.display = 'none';

                    // Stop elapsed timer
                    if (elapsedTimer) {
                        clearInterval(elapsedTimer);
                        elapsedTimer = null;
                        scrapingStartTime = null;
                    }

                } else {
                    addLog('[UI] Error: ' + result.error, 'error');
                }
            } catch (error) {
                addLog('[UI] Error: ' + error.message, 'error');
            }
        });

        // Refresh status
        document.getElementById('refreshBtn').addEventListener('click', refreshStatus);

        async function refreshStatus() {
            try {
                const response = await fetch('/api/status');
                const status = await response.json();

                document.getElementById('totalCompanies').textContent = status.total_companies || 0;
                document.getElementById('totalOfficers').textContent = status.total_officers || 0;

                if (status.is_running) {
                    document.getElementById('statusBadge').className = 'status-badge status-running';
                    document.getElementById('statusBadge').textContent = 'Running';
                    document.getElementById('statusText').textContent = 'Scraping in progress...';
                    document.getElementById('startBtn').style.display = 'none';
                    document.getElementById('stopBtn').style.display = 'inline-block';
                } else if (status.latest_batch) {
                    const batch = status.latest_batch;
                    if (batch.status === 'completed') {
                        document.getElementById('statusBadge').className = 'status-badge status-completed';
                        document.getElementById('statusBadge').textContent = 'Completed';
                        document.getElementById('statusText').textContent = `Last batch: ${batch.search_name} (${batch.companies_count} companies)`;
                    } else if (batch.status === 'failed') {
                        document.getElementById('statusBadge').className = 'status-badge status-failed';
                        document.getElementById('statusBadge').textContent = 'Failed';
                        document.getElementById('statusText').textContent = `Error: ${batch.error_message}`;
                    }
                } else {
                    document.getElementById('statusBadge').className = 'status-badge status-idle';
                    document.getElementById('statusBadge').textContent = 'Idle';
                    document.getElementById('statusText').textContent = 'Ready to start scraping';
                    document.getElementById('startBtn').style.display = 'inline-block';
                    document.getElementById('stopBtn').style.display = 'none';
                }
            } catch (error) {
                console.error('Error refreshing status:', error);
            }
        }

        function connectEventSource() {
            eventSource = new EventSource('/api/logs');

            eventSource.onmessage = (event) => {
                if (event.data.trim()) {
                    addLog(event.data);
                }
            };

            eventSource.onerror = (error) => {
                console.error('EventSource error:', error);
                setTimeout(() => connectEventSource(), 5000);
            };
        }

        function addLog(message, type = 'info') {
            const logsDiv = document.getElementById('logs');
            const logLine = document.createElement('div');
            logLine.className = 'log-line';

            const timestamp = new Date().toLocaleTimeString();
            logLine.textContent = `[${timestamp}] ${message}`;

            if (type === 'error') {
                logLine.style.color = '#e74c3c';
            } else if (type === 'success') {
                logLine.style.color = '#27ae60';
            } else if (type === 'info') {
                logLine.style.color = '#3498db';
            }

            logsDiv.appendChild(logLine);
            logsDiv.scrollTop = logsDiv.scrollHeight;

            // Parse log message for progress updates
            parseProgressFromLog(message);
        }

        function parseProgressFromLog(message) {
            // Look for patterns like: "(5/100) Completed API fetch"
            const progressMatch = message.match(/\((\d+)\/(\d+)\)/);
            if (progressMatch) {
                const completed = parseInt(progressMatch[1]);
                const total = parseInt(progressMatch[2]);
                updateProgressBar(completed, total);
            }

            // Look for rate and ETA: "[2.5 companies/sec, ETA: 3.2 min]"
            const rateMatch = message.match(/\[(\d+\.?\d*)\s+companies\/sec,\s+ETA:\s+(\d+\.?\d*)\s+min\]/);
            if (rateMatch) {
                const rate = parseFloat(rateMatch[1]);
                const etaMinutes = parseFloat(rateMatch[2]);
                updateProgressStats(rate, etaMinutes);
            }

            // Look for "Processing X companies"
            const totalMatch = message.match(/Processing\s+(\d+)\s+companies/);
            if (totalMatch) {
                const total = parseInt(totalMatch[1]);
                document.getElementById('progressTotal').textContent = total;
                document.getElementById('progressContainer').style.display = 'block';
            }

            // Look for completion
            if (message.includes('completed search:') || message.includes('Batch completed:') || message.includes('Scraping was stopped')) {
                // Stop elapsed timer
                if (elapsedTimer) {
                    clearInterval(elapsedTimer);
                    elapsedTimer = null;
                    scrapingStartTime = null;
                }

                // Toggle buttons back
                document.getElementById('startBtn').style.display = 'inline-block';
                document.getElementById('stopBtn').style.display = 'none';

                // Hide progress bar after 3 seconds
                setTimeout(() => {
                    document.getElementById('progressContainer').style.display = 'none';
                    resetProgressBar();
                }, 3000);
            }
        }

        function updateProgressBar(completed, total) {
            const percentage = (completed / total) * 100;

            document.getElementById('progressBar').style.width = percentage + '%';
            document.getElementById('progressBar').textContent = Math.round(percentage) + '%';
            document.getElementById('progressCompleted').textContent = completed;
            document.getElementById('progressTotal').textContent = total;

            // Update text
            document.getElementById('progressText').textContent = `Processing ${completed} of ${total} companies`;
        }

        function updateProgressStats(rate, etaMinutes) {
            document.getElementById('progressRate').textContent = rate.toFixed(1);

            // Format ETA
            if (etaMinutes < 1) {
                const seconds = Math.round(etaMinutes * 60);
                document.getElementById('progressETA').textContent = `ETA: ${seconds}s`;
            } else {
                document.getElementById('progressETA').textContent = `ETA: ${etaMinutes.toFixed(1)} min`;
            }
        }

        function updateElapsedTime(startTime) {
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;

            if (minutes > 0) {
                document.getElementById('progressElapsed').textContent = `${minutes}m ${seconds}s`;
            } else {
                document.getElementById('progressElapsed').textContent = `${seconds}s`;
            }
        }

        function resetProgressBar() {
            document.getElementById('progressBar').style.width = '0%';
            document.getElementById('progressBar').textContent = '0%';
            document.getElementById('progressCompleted').textContent = '0';
            document.getElementById('progressTotal').textContent = '0';
            document.getElementById('progressRate').textContent = '0.0';
            document.getElementById('progressElapsed').textContent = '0s';
        }

        let scrapingStartTime = null;
        let elapsedTimer = null;

        // Auto-refresh status every 5 seconds
        setInterval(refreshStatus, 5000);

        // Duplicates handling
        let selectedToKeep = new Set();
        let allRecordIds = new Set();

        document.getElementById('refreshDuplicatesBtn').addEventListener('click', loadDuplicates);

        document.getElementById('autoSelectBestBtn').addEventListener('click', () => {
            // Clear existing selections
            selectedToKeep.clear();

            // Auto-select best from each group
            document.querySelectorAll('.duplicate-item').forEach(groupElement => {
                const records = groupElement.querySelectorAll('.duplicate-record');
                let bestRecord = null;
                let bestScore = -1;

                records.forEach(recordElement => {
                    const hasOfficers = recordElement.querySelector('.badge-yes') !== null &&
                                       recordElement.textContent.includes('Officers');
                    const hasFinancials = recordElement.querySelector('.badge-yes') !== null &&
                                         recordElement.textContent.includes('Financials');
                    const ingestedText = recordElement.textContent.match(/Ingested:\s*([^‚≠ê]+)/);
                    const ingestedDate = ingestedText ? new Date(ingestedText[1].trim()) : new Date(0);

                    let score = 0;
                    if (hasOfficers) score += 2;
                    if (hasFinancials) score += 2;
                    score += ingestedDate.getTime() / 1e15;

                    if (score > bestScore) {
                        bestScore = score;
                        bestRecord = recordElement;
                    }
                });

                // Unselect all in this group
                records.forEach(recordElement => {
                    const recordId = parseInt(recordElement.dataset.recordId);
                    const button = recordElement.querySelector('button');
                    recordElement.classList.remove('selected');
                    button.textContent = 'Keep This Record';
                    button.style.background = '#27ae60';
                });

                // Select the best
                if (bestRecord) {
                    const recordId = parseInt(bestRecord.dataset.recordId);
                    const button = bestRecord.querySelector('button');
                    selectedToKeep.add(recordId);
                    bestRecord.classList.add('selected');
                    button.textContent = 'Keeping ‚úì';
                    button.style.background = '#229954';
                }
            });

            updateDeleteButton();
            addLog('[UI] Auto-selected best record from each duplicate group', 'info');
        });

        document.getElementById('clearSelectionsBtn').addEventListener('click', () => {
            selectedToKeep.clear();

            document.querySelectorAll('.duplicate-record').forEach(recordElement => {
                const button = recordElement.querySelector('button');
                recordElement.classList.remove('selected');
                button.textContent = 'Keep This Record';
                button.style.background = '#27ae60';
            });

            updateDeleteButton();
            addLog('[UI] Cleared all selections', 'info');
        });

        async function loadDuplicates() {
            try {
                const response = await fetch('/api/duplicates');
                const data = await response.json();

                if (data.duplicates && data.duplicates.length > 0) {
                    document.getElementById('duplicatesSection').style.display = 'block';
                    document.getElementById('duplicateCount').textContent = `${data.duplicates.length} duplicate groups found`;
                    renderDuplicates(data.duplicates);
                } else {
                    document.getElementById('duplicatesSection').style.display = 'none';
                    addLog('[UI] No duplicates found', 'success');
                }
            } catch (error) {
                addLog('[UI] Error loading duplicates: ' + error.message, 'error');
            }
        }

        function renderDuplicates(duplicates) {
            const container = document.getElementById('duplicatesList');
            container.innerHTML = '';
            allRecordIds.clear();

            duplicates.forEach((group, groupIdx) => {
                const item = document.createElement('div');
                item.className = 'duplicate-item';

                const header = document.createElement('div');
                header.className = 'duplicate-header';
                header.textContent = `${group.company_number} - ${group.company_name}`;
                item.appendChild(header);

                const recordsDiv = document.createElement('div');
                recordsDiv.className = 'duplicate-records';

                // Find the best record in this group (prioritize: has both data > most recent)
                let bestRecordId = null;
                let bestScore = -1;

                group.records.forEach(record => {
                    let score = 0;
                    if (record.has_officers) score += 2;
                    if (record.has_financials) score += 2;
                    // Use ingestion time as tiebreaker (most recent)
                    const timestamp = new Date(record.ingested_at).getTime();
                    score += timestamp / 1e15; // Small contribution from timestamp

                    if (score > bestScore) {
                        bestScore = score;
                        bestRecordId = record.id;
                    }
                });

                group.records.forEach((record, recordIdx) => {
                    allRecordIds.add(record.id);

                    const recordDiv = document.createElement('div');
                    recordDiv.className = 'duplicate-record';
                    recordDiv.dataset.recordId = record.id;

                    const info = document.createElement('div');
                    info.className = 'duplicate-info';

                    const hasOfficers = record.has_officers ?
                        '<span class="data-badge badge-yes">Officers ‚úì</span>' :
                        '<span class="data-badge badge-no">No Officers</span>';

                    const hasFinancials = record.has_financials ?
                        '<span class="data-badge badge-yes">Financials ‚úì</span>' :
                        '<span class="data-badge badge-no">No Financials</span>';

                    const isBest = record.id === bestRecordId;

                    info.innerHTML = `
                        <span><strong>Batch:</strong> ${record.batch_id}</span>
                        <span><strong>Ingested:</strong> ${new Date(record.ingested_at).toLocaleString()}</span>
                        ${isBest ? '<span class="data-badge" style="background: #9b59b6; color: white;">‚≠ê Best</span>' : ''}
                        <br>
                        ${hasOfficers}
                        ${hasFinancials}
                    `;
                    recordDiv.appendChild(info);

                    const actions = document.createElement('div');
                    actions.className = 'duplicate-actions';

                    const selectBtn = document.createElement('button');
                    selectBtn.textContent = 'Keep This Record';
                    selectBtn.className = 'btn-small';
                    selectBtn.style.background = '#27ae60';
                    selectBtn.style.color = 'white';
                    selectBtn.onclick = () => toggleSelectToKeep(record.id, recordDiv, selectBtn);
                    actions.appendChild(selectBtn);

                    recordDiv.appendChild(actions);
                    recordsDiv.appendChild(recordDiv);

                    // Auto-select the best record
                    if (isBest) {
                        selectedToKeep.add(record.id);
                        recordDiv.classList.add('selected');
                        selectBtn.textContent = 'Keeping ‚úì';
                        selectBtn.style.background = '#229954';
                    }
                });

                item.appendChild(recordsDiv);
                container.appendChild(item);
            });

            updateDeleteButton();
        }

        function toggleSelectToKeep(recordId, element, button) {
            if (selectedToKeep.has(recordId)) {
                selectedToKeep.delete(recordId);
                element.classList.remove('selected');
                button.textContent = 'Keep This Record';
                button.style.background = '#27ae60';
            } else {
                selectedToKeep.add(recordId);
                element.classList.add('selected');
                button.textContent = 'Keeping ‚úì';
                button.style.background = '#229954';
            }
            updateDeleteButton();
        }

        function updateDeleteButton() {
            const deleteBtn = document.getElementById('deleteUnselectedBtn');
            const toDelete = allRecordIds.size - selectedToKeep.size;

            if (toDelete > 0 && selectedToKeep.size > 0) {
                deleteBtn.style.display = 'inline-block';
                deleteBtn.textContent = `Delete ${toDelete} Unselected Record(s)`;
            } else if (allRecordIds.size > 0 && selectedToKeep.size === 0) {
                deleteBtn.style.display = 'inline-block';
                deleteBtn.textContent = `Delete All ${allRecordIds.size} Record(s)`;
            } else {
                deleteBtn.style.display = 'none';
            }
        }

        document.getElementById('deleteUnselectedBtn').addEventListener('click', async () => {
            // Calculate which records to delete (all except the ones marked to keep)
            const toDelete = Array.from(allRecordIds).filter(id => !selectedToKeep.has(id));
            const toDeleteCount = toDelete.length;

            if (toDeleteCount === 0) {
                addLog('[UI] No records to delete', 'info');
                return;
            }

            const confirmMessage = selectedToKeep.size > 0
                ? `Are you sure you want to delete ${toDeleteCount} unselected record(s)? You are keeping ${selectedToKeep.size} record(s). This cannot be undone.`
                : `Are you sure you want to delete all ${toDeleteCount} duplicate record(s)? This cannot be undone.`;

            if (!confirm(confirmMessage)) {
                return;
            }

            try {
                const response = await fetch('/api/duplicates/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ record_ids: toDelete })
                });

                const result = await response.json();

                if (result.success) {
                    addLog(`[UI] Successfully deleted ${result.deleted_count} duplicate record(s)`, 'success');
                    selectedToKeep.clear();
                    allRecordIds.clear();
                    loadDuplicates();
                    refreshStatus();
                } else {
                    addLog('[UI] Error deleting duplicates: ' + result.error, 'error');
                }
            } catch (error) {
                addLog('[UI] Error: ' + error.message, 'error');
            }
        });

        // Load duplicates on page load
        loadDuplicates();
    </script>
</body>
</html>
